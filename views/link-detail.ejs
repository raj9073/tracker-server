<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head', { title: 'Clicks - ' + link.short_code }) %>
  <style>
    .view-toggle .btn { margin-right: 8px; }
    .view-toggle .btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    #view-table { overflow-x: auto; }
    #view-table table { min-width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <p><a href="/dashboard">← Back to dashboard</a></p>
    <h1>/<%= link.short_code %></h1>
    <p style="color: #8b949e;">→ <a href="<%= link.original_url %>" target="_blank"><%= link.original_url %></a></p>
    <div class="flex" style="align-items: center; gap: 16px; flex-wrap: wrap;">
      <p style="margin: 0;"><strong><%= clicks.length %></strong> clicks</p>
      <% if (clicks.length > 0) { %>
        <a href="/dashboard/links/<%= link.id %>/export/csv" class="btn btn-secondary">Download CSV</a>
      <% } %>
    </div>
    <% var msg = typeof deleted !== 'undefined' && deleted ? 'Data entry deleted.' : (typeof error !== 'undefined' && error ? 'Failed to delete.' : null); %>
    <% if (msg) { %><p class="mt" style="color: var(--<%= error ? 'danger' : 'success' %>);"><%= msg %></p><% } %>
    <% if (clicks.length === 0) { %>
      <p>No clicks yet.</p>
    <% } else { %>
      <div class="view-toggle mt">
        <button type="button" class="btn btn-secondary" id="btn-json">JSON</button>
        <button type="button" class="btn btn-secondary" id="btn-table">Table</button>
      </div>
      <div id="view-json">
        <table class="mt">
          <thead>
            <tr>
              <th>Time</th>
              <th>IP</th>
              <th>WebRTC IP</th>
              <th>Location</th>
              <th>Coordinates</th>
              <th>Referrer</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% clicks.forEach(function(c) { %>
              <tr>
                <td><%= new Date(c.clicked_at).toLocaleString() %></td>
                <td><%= (c.fingerprint && c.fingerprint.ip) || c.ip || '-' %></td>
                <td><%= c.webrtc_ip || (c.fingerprint && (c.fingerprint.rtc_localIPv4 || c.fingerprint.rtc_localIPv6 || c.fingerprint.rtc_publicIP)) || '-' %></td>
                <td><% var fc=(c.fingerprint&&c.fingerprint.city)||c.city,fco=(c.fingerprint&&c.fingerprint.country)||c.country; %><%= fc&&fco?fc+', '+fco:(fc||fco||'-') %></td>
                <td>
                  <% var clat = (c.fingerprint && c.fingerprint.lat) ?? c.lat, clng = (c.fingerprint && c.fingerprint.lng) ?? c.lng; %>
                  <% if (clat != null && clng != null) { %>
                    <a href="https://www.google.com/maps?q=<%= clat %>,<%= clng %>" target="_blank" style="color:#ff6b6b;"><%= Number(clat).toFixed(4) %>, <%= Number(clng).toFixed(4) %></a>
                  <% } else { %>
                    -
                  <% } %>
                </td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;"><%= (c.fingerprint && c.fingerprint.referrer) || c.referrer || '-' %></td>
                <td>
                  <form method="POST" action="/dashboard/links/<%= link.id %>/clicks/<%= c.id %>/delete" style="margin:0;" onsubmit="return confirm('Delete this data entry?');">
                    <button type="submit" class="btn btn-danger" style="padding:6px 12px;font-size:13px;">Delete</button>
                  </form>
                </td>
              </tr>
              <% if (c.fingerprint && typeof c.fingerprint === 'object' && Object.keys(c.fingerprint).length > 0) { %>
              <tr>
                <td colspan="7" style="padding:0;border:none;background:var(--card-bg);vertical-align:top;">
                  <details class="fingerprint-details">
                    <summary style="cursor:pointer;padding:8px 16px;color:var(--accent);">View full fingerprint</summary>
                    <pre style="margin:0;padding:16px;font-size:12px;overflow:auto;max-height:400px;white-space:pre-wrap;word-break:break-all;"><%= JSON.stringify(c.fingerprint, null, 2) %></pre>
                  </details>
                </td>
              </tr>
              <% } %>
            <% }); %>
          </tbody>
        </table>
      </div>
      <div id="view-table" style="display:none;" class="mt">
        <table>
          <thead id="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    <% } %>
  </div>
  <% if (clicks.length > 0) { %>
  <script>
    window.__CLICKS__ = <%- JSON.stringify(clicks) %>;
    (function(){
      var clicks = window.__CLICKS__;
      var keys = ['clicked_at','id','ip','webrtc_ip'];
      clicks.forEach(function(c){
        var fp = c.fingerprint || {};
        Object.keys(fp).forEach(function(k){ if(keys.indexOf(k)===-1) keys.push(k); });
      });
      keys = ['clicked_at','id','ip','webrtc_ip'].concat(keys.filter(function(k){ return ['clicked_at','id','ip','webrtc_ip'].indexOf(k)===-1; }).sort());
      function val(c,k){
        var fp = c.fingerprint || {};
        if(k==='clicked_at') return c.clicked_at;
        if(k==='id') return c.id;
        if(k==='ip') return c.ip || fp.ip;
        if(k==='webrtc_ip') return c.webrtc_ip || fp.rtc_localIPv4 || fp.rtc_localIPv6 || fp.rtc_publicIP || fp.webrtc_ip;
        return fp[k];
      }
      function str(v){
        if(v==null) return '';
        return typeof v==='object' ? JSON.stringify(v) : String(v);
      }
      var thead = document.getElementById('table-head');
      var tbody = document.getElementById('table-body');
      var tr = document.createElement('tr');
      keys.forEach(function(k){ var th=document.createElement('th'); th.textContent=k; tr.appendChild(th); });
      var th = document.createElement('th'); th.textContent='Actions'; tr.appendChild(th);
      thead.appendChild(tr);
      clicks.forEach(function(c){
        var row = document.createElement('tr');
        keys.forEach(function(k){ var td=document.createElement('td'); td.textContent=str(val(c,k)); td.style.maxWidth='200px'; td.style.overflow='hidden'; td.style.textOverflow='ellipsis'; row.appendChild(td); });
        var td = document.createElement('td');
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/dashboard/links/<%= link.id %>/clicks/' + c.id + '/delete';
        form.onsubmit = function(){ return confirm('Delete this data entry?'); };
        var btn = document.createElement('button');
        btn.type = 'submit';
        btn.className = 'btn btn-danger';
        btn.style.cssText = 'padding:6px 12px;font-size:13px;';
        btn.textContent = 'Delete';
        form.appendChild(btn);
        td.appendChild(form);
        row.appendChild(td);
        tbody.appendChild(row);
      });
      document.getElementById('btn-json').classList.add('active');
      document.getElementById('btn-json').onclick = function(){
        document.getElementById('view-json').style.display = '';
        document.getElementById('view-table').style.display = 'none';
        document.getElementById('btn-json').classList.add('active');
        document.getElementById('btn-table').classList.remove('active');
      };
      document.getElementById('btn-table').onclick = function(){
        document.getElementById('view-json').style.display = 'none';
        document.getElementById('view-table').style.display = 'block';
        document.getElementById('btn-table').classList.add('active');
        document.getElementById('btn-json').classList.remove('active');
      };
    })();
  </script>
  <% } %>
</body>
</html>
