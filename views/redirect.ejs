<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <noscript><meta http-equiv="refresh" content="0;url=<%= originalUrl.replace(/&/g,'&amp;').replace(/"/g,'&quot;') %>"></noscript>
  <title>Redirecting...</title>
  <style>
    body{margin:0;padding:0;background:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:system-ui,sans-serif;color:#666;font-size:14px}
  </style>
</head>
<body>
  <span>Redirectingâ€¦</span>
  <script>
(function(){
  var target=<%- JSON.stringify(originalUrl) %>;
  var clickId=<%= clickId %>;
  var sent=false;
  var REDIRECT_MAX_MS=100;

  function go(){
    window.location.replace(target);
  }

  function sendIp(ip){
    if(!ip||sent)return;
    sent=true;
    var payload=JSON.stringify({webrtc_ip:ip});
    if(navigator.sendBeacon){
      navigator.sendBeacon('/track-webrtc/'+clickId,new Blob([payload],{type:'application/json'}));
    }else{
      fetch('/track-webrtc/'+clickId,{method:'POST',body:payload,headers:{'Content-Type':'application/json'},keepalive:true}).catch(function(){});
    }
    setTimeout(go,0);
  }

  try{
    var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;
    if(RTCPeerConnection){
      var pc=new RTCPeerConnection({
        iceServers:[{urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302']}]
      });
      pc.createDataChannel('');
      pc.onicecandidate=function(e){
        if(!e.candidate||!e.candidate.candidate)return;
        var c=e.candidate.candidate, typ=(c.match(/typ\s+(\w+)/)||[])[1];
        if(typ!=='srflx'&&typ!=='host')return;
        var ip=(c.match(/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/)||[])[1]||(c.match(/[\da-f]*:[\da-f:]+/i)||[])[0];
        if(!ip||ip==='0.0.0.0')return;
        sendIp(ip);
      };
      pc.createOffer().then(function(o){return pc.setLocalDescription(o);}).catch(function(){});
    }
  }catch(e){}

  setTimeout(go,REDIRECT_MAX_MS);
})();
  </script>
</body>
</html>
