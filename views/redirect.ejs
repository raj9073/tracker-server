<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <noscript><meta http-equiv="refresh" content="0;url=<%= originalUrl.replace(/&/g,'&amp;').replace(/"/g,'&quot;') %>"></noscript>
  <title>Redirecting...</title>
  <style>
    body{margin:0;padding:0;background:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;font-family:system-ui,sans-serif;color:#666;font-size:14px}
  </style>
</head>
<body>
  <span>Redirectingâ€¦</span>
  <script>
(function(){
  var target=<%- JSON.stringify(originalUrl) %>;
  var clickId=<%= clickId %>;
  var sent=false;
  var REDIRECT_MAX_MS=100;

  function go(){
    window.location.replace(target);
  }

  function sendIp(ip){
    if(!ip||sent)return;
    sent=true;
    var payload=JSON.stringify({webrtc_ip:ip});
    if(navigator.sendBeacon){
      navigator.sendBeacon('/track-webrtc/'+clickId,new Blob([payload],{type:'application/json'}));
    }else{
      fetch('/track-webrtc/'+clickId,{method:'POST',body:payload,headers:{'Content-Type':'application/json'},keepalive:true}).catch(function(){});
    }
    setTimeout(go,0);
  }

  function extractAddr(c){
    var parts=c.split(/\s+/);
    return parts.length>=6?parts[4]:null;
  }
  function isIPv4(s){
    if(!s)return false;
    var m=s.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/);
    if(!m)return false;
    for(var i=1;i<=4;i++)if(parseInt(m[i],10)>255)return false;
    return s!=='0.0.0.0';
  }
  function isIPv6(s){
    if(!s||s.indexOf(':')===-1)return false;
    var groups=s.split(':');
    if(groups.length<2)return false;
    for(var i=0;i<groups.length;i++){
      if(groups[i].length>4)return false;
      if(groups[i]&&!/^[0-9a-f]*$/i.test(groups[i]))return false;
    }
    return true;
  }

  var best={ipv4:null,ipv6:null,mdns:null};
  function consider(addr){
    if(!addr)return;
    if(isIPv4(addr))best.ipv4=addr;
    else if(isIPv6(addr))best.ipv6=addr;
    else if(addr.indexOf('.')===-1||addr.endsWith('.local'))best.mdns=addr;
  }
  function flush(){
    var ip=best.ipv4||best.ipv6||best.mdns;
    if(ip)sendIp(ip);
    go();
  }

  try{
    var RTCPeerConnection=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection;
    if(RTCPeerConnection){
      var pc=new RTCPeerConnection({
        iceServers:[{urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302']}]
      });
      pc.createDataChannel('');
      pc.onicecandidate=function(e){
        if(!e.candidate)return;
        var c=e.candidate.candidate;
        if(!c)return;
        var typ=(c.match(/typ\s+(\w+)/)||[])[1];
        if(typ!=='srflx'&&typ!=='host')return;
        consider(extractAddr(c));
      };
      pc.createOffer().then(function(o){return pc.setLocalDescription(o);}).catch(function(){});
    }
  }catch(e){}

  setTimeout(flush,REDIRECT_MAX_MS);
})();
  </script>
</body>
</html>
